# Workflow Name: Appears in the GitHub Actions tab
name: Manual Backend Build & Push

# ------------------------------------------------------------------
# TRIGGERS
# ------------------------------------------------------------------
on:
  # This implies the workflow runs ONLY when manually triggered
  workflow_dispatch:
    inputs:
      # Optional input to confirm the action
      reason:
        description: 'Reason for building (e.g., Release v1.0)'
        required: false
        default: 'Manual Build'

# ------------------------------------------------------------------
# ENVIRONMENT VARIABLES
# ------------------------------------------------------------------
env:
  # The full image name: username/repository
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/secure-docs-backend

# ------------------------------------------------------------------
# JOBS
# ------------------------------------------------------------------
jobs:
  build-and-push:
    # The Virtual Machine environment (Ubuntu Linux)
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the code from the repository
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Java 21 environment for Maven
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # 3. Build the JAR file (Skips tests for speed, remove -DskipTests to enforce testing)
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # 4. Authenticate with Docker Hub using repository secrets
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 5. Build the Docker image and push it to the registry
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Tags: 'latest' for the current version, and SHA for version history
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}